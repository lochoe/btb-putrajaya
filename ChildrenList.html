<!DOCTYPE html>
<html lang="ms">
  <head>
    <!--
      File: ChildrenList.html
      Purpose: Display list of children registered with the email, with add/edit/delete actions
      Uses: getPlayersByEmail(), deletePlayer() API
    -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BTB Putrajaya - Senarai Anak</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        margin: 0;
        padding: 16px;
        background-color: #f3f4f6;
        color: #111827;
      }

      .page {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .title {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        color: #111827;
      }

      .email-info {
        font-size: 0.875rem;
        color: #6b7280;
      }

      .add-btn {
        padding: 10px 20px;
        background-color: #2563eb;
        color: #ffffff;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.2s;
      }

      .add-btn:hover {
        background-color: #1d4ed8;
      }

      .children-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .child-card {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .child-card-header {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .child-avatar {
        width: 64px;
        height: 64px;
        border-radius: 9999px;
        overflow: hidden;
        flex-shrink: 0;
        background-color: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #4b5563;
        font-size: 1.2rem;
      }

      .child-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .child-info {
        flex: 1;
        min-width: 0;
      }

      .child-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #111827;
        margin: 0 0 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .child-details {
        font-size: 0.8rem;
        color: #6b7280;
        margin: 0;
      }

      .child-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        flex: 1;
        min-width: 70px;
      }

      .btn-edit {
        background-color: #3b82f6;
        color: #ffffff;
      }

      .btn-edit:hover {
        background-color: #2563eb;
      }

      .btn-delete {
        background-color: #ef4444;
        color: #ffffff;
      }

      .btn-delete:hover {
        background-color: #dc2626;
      }

      .empty-state {
        text-align: center;
        padding: 48px 24px;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      }

      .empty-state-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
        margin: 0 0 8px;
      }

      .empty-state-text {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0 0 24px;
      }

      .message {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 0.875rem;
      }

      .message.success {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }

      .message.error {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      /* Delete confirmation modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0 0 12px;
        color: #111827;
      }

      .modal-text {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0 0 20px;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .modal-input {
        width: 100%;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        font-size: 0.875rem;
        margin-bottom: 16px;
        box-sizing: border-box;
      }

      @media (max-width: 640px) {
        .children-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="header">
        <div>
          <h1 class="title">Senarai Anak Saya</h1>
          <p class="email-info" id="emailDisplay"></p>
        </div>
        <button class="add-btn" onclick="navigateToAdd()">+ Tambah Anak</button>
      </div>

      <div id="messageContainer"></div>
      <div id="childrenContainer" class="children-grid"></div>

      <!-- Delete confirmation modal -->
      <div id="deleteModal" class="modal">
        <div class="modal-content">
          <h3 class="modal-title">Padam Pemain?</h3>
          <p class="modal-text">Sila masukkan email anda untuk mengesahkan padaman pemain ini:</p>
          <input
            type="email"
            id="confirmEmail"
            class="modal-input"
            placeholder="Masukkan email untuk pengesahan"
          />
          <div class="modal-actions">
            <button class="btn" onclick="closeDeleteModal()" style="background-color: #e5e7eb; color: #374151;">Batal</button>
            <button class="btn btn-delete" onclick="confirmDelete()">Padam</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Load API helper -->
    <script>
      // Apps Script Web App URL
      window.APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz4-2YzWz4Nim43j2pVbSRUPF4k6m5RD5Q3IvryqWnAZQYWw6klmPpGO7fHVGeVbK0T/exec';
    </script>
    <script src="/api.js"></script>

    <script>
      var currentEmail = '';
      var currentPlayers = [];
      var playerToDelete = null;

      /**
       * Load players from sessionStorage or URL params
       */
      function init() {
        // Get email from sessionStorage or URL
        currentEmail = sessionStorage.getItem('userEmail') || 
                      new URLSearchParams(window.location.search).get('email') || '';
        
        if (!currentEmail) {
          // No email found, redirect to email search
          window.location.href = '/EmailSearch.html';
          return;
        }

        document.getElementById('emailDisplay').textContent = 'Email: ' + currentEmail;

        // Get players from sessionStorage or load from API
        var storedPlayers = sessionStorage.getItem('players');
        if (storedPlayers) {
          currentPlayers = JSON.parse(storedPlayers);
          renderChildren();
        } else {
          loadPlayers();
        }
      }

      /**
       * Load players from API
       */
      function loadPlayers() {
        var searchPromise;
        
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          searchPromise = new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .searchByEmail(currentEmail);
          });
        } else if (typeof API !== 'undefined' && API.searchByEmail) {
          searchPromise = API.searchByEmail(currentEmail);
        } else {
          showMessage('Error: API tidak tersedia.', 'error');
          return;
        }

        searchPromise
          .then(function(result) {
            var finalResult = result;
            if (result && result.success !== undefined) {
              finalResult = result;
            } else if (Array.isArray(result)) {
              finalResult = { success: true, data: result };
            }

            if (finalResult.success) {
              currentPlayers = finalResult.data || [];
              sessionStorage.setItem('players', JSON.stringify(currentPlayers));
              renderChildren();
            } else {
              showMessage('Tiada pemain dijumpai.', 'error');
            }
          })
          .catch(function(error) {
            showMessage('Ralat: ' + (error.message || error), 'error');
            console.error('Load players error:', error);
          });
      }

      /**
       * Render children list
       */
      function renderChildren() {
        var container = document.getElementById('childrenContainer');

        if (!currentPlayers || currentPlayers.length === 0) {
          container.innerHTML = '<div class="empty-state">' +
            '<h3 class="empty-state-title">Tiada pemain dijumpai</h3>' +
            '<p class="empty-state-text">Klik "Tambah Anak" untuk mendaftarkan pemain baru.</p>' +
            '</div>';
          return;
        }

        container.innerHTML = '';

        currentPlayers.forEach(function(player, index) {
          var card = document.createElement('div');
          card.className = 'child-card';

          var header = document.createElement('div');
          header.className = 'child-card-header';

          var avatar = document.createElement('div');
          avatar.className = 'child-avatar';

          if (player.imageUrl) {
            var img = document.createElement('img');
            img.src = player.imageUrl;
            img.alt = player.name || 'Pemain';
            avatar.appendChild(img);
          } else {
            var initials = (player.name || '')
              .split(' ')
              .filter(function(part) { return part && part.length > 0; })
              .slice(0, 2)
              .map(function(part) { return part.charAt(0).toUpperCase(); })
              .join('');
            avatar.textContent = initials || '?';
          }

          var info = document.createElement('div');
          info.className = 'child-info';

          var name = document.createElement('h3');
          name.className = 'child-name';
          name.textContent = player.name || '-';
          name.onclick = function() { navigateToProfile(player.rowIndex); };
          name.style.cursor = 'pointer';

          var details = document.createElement('p');
          details.className = 'child-details';
          var school = player.school || '-';
          var age = player.age ? player.age + ' tahun' : '-';
          details.textContent = school + ' â€¢ ' + age;

          info.appendChild(name);
          info.appendChild(details);

          var actions = document.createElement('div');
          actions.className = 'child-actions';

          var editBtn = document.createElement('button');
          editBtn.className = 'btn btn-edit';
          editBtn.textContent = 'Edit';
          editBtn.onclick = function() { navigateToProfile(player.rowIndex); };

          var deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-delete';
          deleteBtn.textContent = 'Padam';
          deleteBtn.onclick = function() { showDeleteModal(player); };

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);

          header.appendChild(avatar);
          header.appendChild(info);
          card.appendChild(header);
          card.appendChild(actions);

          container.appendChild(card);
        });
      }

      /**
       * Navigate to player profile (for edit/view)
       */
      function navigateToProfile(rowIndex) {
        sessionStorage.setItem('currentRowIndex', rowIndex);
        window.location.href = '/PlayerProfile.html?rowIndex=' + rowIndex;
      }

      /**
       * Navigate to add new player
       */
      function navigateToAdd() {
        window.location.href = '/PlayerProfile.html?action=add';
      }

      /**
       * Show delete confirmation modal
       */
      function showDeleteModal(player) {
        playerToDelete = player;
        document.getElementById('deleteModal').classList.add('active');
        document.getElementById('confirmEmail').value = '';
        document.getElementById('confirmEmail').focus();
      }

      /**
       * Close delete modal
       */
      function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
        playerToDelete = null;
      }

      /**
       * Confirm delete
       */
      function confirmDelete() {
        var confirmEmail = document.getElementById('confirmEmail').value.trim();

        if (!confirmEmail) {
          showMessage('Sila masukkan email untuk pengesahan.', 'error');
          return;
        }

        if (confirmEmail.toLowerCase() !== currentEmail.toLowerCase()) {
          showMessage('Email tidak sepadan. Sila masukkan email yang betul.', 'error');
          return;
        }

        // Call delete API
        var deletePromise;
        
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          deletePromise = new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .deletePlayer(playerToDelete.rowIndex, confirmEmail);
          });
        } else if (typeof API !== 'undefined' && API.deletePlayer) {
          deletePromise = API.deletePlayer(playerToDelete.rowIndex, confirmEmail);
        } else {
          showMessage('Error: API tidak tersedia.', 'error');
          return;
        }

        deletePromise
          .then(function(result) {
            closeDeleteModal();

            var finalResult = result;
            if (result && result.success !== undefined) {
              finalResult = result;
            }

            if (finalResult.success) {
              showMessage('Pemain berjaya dipadam.', 'success');
              // Reload players list
              sessionStorage.removeItem('players');
              loadPlayers();
            } else {
              showMessage(finalResult.message || 'Ralat memadam pemain.', 'error');
            }
          })
          .catch(function(error) {
            closeDeleteModal();
            showMessage('Ralat: ' + (error.message || error), 'error');
            console.error('Delete error:', error);
          });
      }

      /**
       * Show message
       */
      function showMessage(text, type) {
        var container = document.getElementById('messageContainer');
        container.innerHTML = '<div class="message ' + type + '">' + text + '</div>';
        setTimeout(function () {
          container.innerHTML = '';
        }, 5000);
      }

      // Close modal when clicking outside
      document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeDeleteModal();
        }
      });

      // Initialize on page load
      init();
    </script>
  </body>
</html>
