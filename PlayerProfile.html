<!DOCTYPE html>
<html lang="ms">
  <head>
    <!--
      File: PlayerProfile.html
      Purpose: Player profile page with edit functionality and jersey booking form
      Uses: getPlayerById(), updatePlayer(), submitJerseyBooking() API
    -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BTB Putrajaya - Profil Pemain</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        margin: 0;
        padding: 16px;
        background-color: #f3f4f6;
        color: #111827;
      }

      .page {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .title {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        color: #111827;
      }

      .back-btn {
        padding: 8px 16px;
        background-color: #e5e7eb;
        color: #374151;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.2s;
      }

      .back-btn:hover {
        background-color: #d1d5db;
      }

      .section {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0 0 20px;
        color: #111827;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 8px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 6px;
      }

      .form-label .required {
        color: #dc2626;
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 0.875rem;
        outline: none;
        background-color: #f9fafb;
        box-sizing: border-box;
      }

      .form-textarea {
        resize: vertical;
        min-height: 80px;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
        background-color: #ffffff;
      }

      .form-input:disabled {
        background-color: #f3f4f6;
        cursor: not-allowed;
      }

      .form-help {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 4px;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: background-color 0.2s;
      }

      .btn-primary {
        background-color: #2563eb;
        color: #ffffff;
      }

      .btn-primary:hover {
        background-color: #1d4ed8;
      }

      .btn-primary:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
      }

      .btn-secondary {
        background-color: #e5e7eb;
        color: #374151;
      }

      .btn-secondary:hover {
        background-color: #d1d5db;
      }

      .btn-edit {
        background-color: #3b82f6;
        color: #ffffff;
      }

      .btn-edit:hover {
        background-color: #2563eb;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
      }

      .message {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 0.875rem;
      }

      .message.success {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }

      .message.error {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      .message.info {
        background-color: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }

      .player-avatar-section {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid #e5e7eb;
      }

      .player-avatar {
        width: 120px;
        height: 120px;
        border-radius: 9999px;
        overflow: hidden;
        flex-shrink: 0;
        background-color: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #4b5563;
        font-size: 2rem;
      }

      .player-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .bank-info {
        background-color: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        font-size: 0.875rem;
        line-height: 1.6;
      }

      .bank-info h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #166534;
        margin: 0 0 8px;
      }

      .bank-info p {
        margin: 4px 0;
        color: #15803d;
      }

      .jersey-number-info {
        background-color: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
        font-size: 0.875rem;
      }

      .taken-numbers {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
      }

      .taken-badge {
        background-color: #fee2e2;
        color: #991b1b;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      input[type="file"] {
        padding: 6px;
        cursor: pointer;
      }

      input[type="file"]::-webkit-file-upload-button {
        padding: 6px 12px;
        margin-right: 8px;
        border: none;
        border-radius: 6px;
        background-color: #2563eb;
        color: #ffffff;
        font-size: 0.875rem;
        cursor: pointer;
      }

      @media (max-width: 640px) {
        .player-avatar-section {
          flex-direction: column;
          text-align: center;
        }

        .form-actions {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="header">
        <h1 class="title" id="pageTitle">Profil Pemain</h1>
        <button class="back-btn" onclick="goBack()">← Kembali ke Senarai</button>
      </div>

      <div id="messageContainer"></div>

      <!-- Player Info Section -->
      <div class="section" id="playerInfoSection">
        <h2 class="section-title">Maklumat Pemain</h2>
        
        <div class="player-avatar-section">
          <div class="player-avatar" id="playerAvatar"></div>
          <div style="flex: 1;">
            <h3 style="margin: 0 0 8px; font-size: 1.5rem;" id="playerNameDisplay">-</h3>
            <p style="margin: 0; color: #6b7280; font-size: 0.875rem;" id="playerDetailsDisplay">-</p>
          </div>
        </div>

        <div id="playerFormContainer">
          <form id="playerForm">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
              <div class="form-group">
                <label class="form-label">
                  Nama Penuh Pemain <span class="required">*</span>
                </label>
                <input type="text" id="name" class="form-input" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  Umur <span class="required">*</span>
                </label>
                <input type="number" id="age" class="form-input" required min="1" max="30" />
              </div>

              <div class="form-group">
                <label class="form-label">
                  Email <span class="required">*</span>
                </label>
                <input type="email" id="email" class="form-input" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  No. IC Pemain <span class="required">*</span>
                </label>
                <input type="text" id="icNumber" class="form-input" required placeholder="123456-78-9012" />
              </div>

              <div class="form-group">
                <label class="form-label">
                  Nama Ibu Bapa Penjaga <span class="required">*</span>
                </label>
                <input type="text" id="parentName" class="form-input" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  No. Telefon Ibu Bapa <span class="required">*</span>
                </label>
                <input type="tel" id="parentPhone" class="form-input" required />
              </div>

              <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label">
                  Alamat <span class="required">*</span>
                </label>
                <textarea id="address" class="form-textarea" required></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">
                  Sekolah <span class="required">*</span>
                </label>
                <input type="text" id="school" class="form-input" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  Tahap Penguasaan <span class="required">*</span>
                </label>
                <select id="skillLevel" class="form-select" required>
                  <option value="">-- Pilih --</option>
                  <option value="BEGINNER">BEGINNER</option>
                  <option value="BASIC">BASIC</option>
                  <option value="INTERMEDIATE">INTERMEDIATE</option>
                  <option value="ADVANCED">ADVANCED</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  Pencapaian
                </label>
                <input type="text" id="achievement" class="form-input" />
              </div>

              <div class="form-group">
                <label class="form-label">
                  Persetujuan Ibu Bapa
                </label>
                <input type="text" id="parentConsent" class="form-input" />
              </div>
            </div>

              <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label">
                  Gambar Pelatih
                </label>
                <input type="file" id="playerImage" class="form-input" accept="image/*" />
                <div class="form-help">Upload gambar pelatih (JPG, PNG, maksimum 5MB)</div>
                <div id="imagePreview" style="margin-top: 12px;">
                  <img id="imagePreviewImg" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #d1d5db; display: none;" />
                </div>
                <div id="currentImageInfo" style="margin-top: 8px; font-size: 0.8rem; color: #6b7280;"></div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary" id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">Batal</button>
              <button type="button" class="btn btn-edit" id="editBtn" onclick="enableEdit()">Edit Maklumat</button>
              <button type="submit" class="btn btn-primary" id="saveBtn" style="display: none;">Simpan Perubahan</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Documents Section -->
      <div class="section" id="documentsSection">
        <h2 class="section-title">Dokumen Pemain</h2>

        <div class="form-group">
          <label class="form-label">
            Salinan IC Pemain <span class="required">*</span>
          </label>
          <input type="file" id="icDocument" class="form-input" accept="image/*,.pdf" />
          <div class="form-help">Upload salinan IC pemain (Gambar atau PDF, maksimum 10MB)</div>
          <div id="icPreview" style="margin-top: 12px;">
            <div id="icPreviewContent"></div>
          </div>
          <div id="currentICInfo" style="margin-top: 8px; font-size: 0.8rem; color: #6b7280;"></div>
          <button type="button" class="btn btn-primary" id="uploadICBtn" onclick="uploadICDocument()" style="margin-top: 12px;">Upload IC</button>
        </div>
      </div>
    </div>

    <!-- Load API helper -->
    <script>
      // Apps Script Web App URL
      window.APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz4-2YzWz4Nim43j2pVbSRUPF4k6m5RD5Q3IvryqWnAZQYWw6klmPpGO7fHVGeVbK0T/exec';
    </script>
    <script src="/api.js"></script>

    <script>
      var currentPlayer = null;
      var currentRowIndex = null;
      var isEditMode = false;
      var isNewPlayer = false;
      var originalFormData = {};

      /**
       * Initialize page
       */
      function init() {
        var urlParams = new URLSearchParams(window.location.search);
        var action = urlParams.get('action');
        var rowIndex = urlParams.get('rowIndex') || sessionStorage.getItem('currentRowIndex');

        if (action === 'add') {
          // Adding new player
          isNewPlayer = true;
          isEditMode = true;
          document.getElementById('pageTitle').textContent = 'Tambah Anak Baru';
          
          // Pre-fill email from sessionStorage if available
          var userEmail = sessionStorage.getItem('userEmail');
          if (userEmail) {
            document.getElementById('email').value = userEmail;
          }
          
          // Enable edit mode (all fields editable)
          var inputs = document.getElementById('playerForm').querySelectorAll('input, select, textarea');
          inputs.forEach(function(input) {
            input.disabled = false;
          });
          document.getElementById('editBtn').style.display = 'none';
          document.getElementById('saveBtn').style.display = 'inline-block';
          document.getElementById('cancelEditBtn').style.display = 'inline-block';
          
        } else if (rowIndex) {
          // Viewing/editing existing player
          currentRowIndex = parseInt(rowIndex);
          loadPlayer(currentRowIndex);
        } else {
          showMessage('Ralat: Tiada maklumat pemain.', 'error');
        }
      }

      /**
       * Load player data
       */
      function loadPlayer(rowIndex) {
        var getPromise;
        
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          getPromise = new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getPlayerById(rowIndex);
          });
        } else if (typeof API !== 'undefined' && API.getPlayerById) {
          getPromise = API.getPlayerById(rowIndex);
        } else {
          showMessage('Error: API tidak tersedia.', 'error');
          return;
        }

        getPromise
          .then(function(result) {
            console.log('loadPlayer - API response:', result);
            
            var playerData = null;
            
            // Handle different response formats
            if (result && result.success && result.data) {
              // Format: {success: true, data: {...}}
              playerData = result.data;
            } else if (result && result.data) {
              // Format: {data: {...}}
              playerData = result.data;
            } else if (result && result.name) {
              // Format: direct player object
              playerData = result;
            } else if (result) {
              // Try to use result directly
              playerData = result;
            }

            if (playerData && playerData.name) {
              currentPlayer = playerData;
              console.log('loadPlayer - Player data loaded:', currentPlayer);
              populatePlayerForm(currentPlayer);
              updateAvatar(currentPlayer);
            } else {
              console.error('loadPlayer - Invalid player data:', result);
              showMessage('Pemain tidak dijumpai atau data tidak sah.', 'error');
            }
          })
          .catch(function(error) {
            console.error('Load player error:', error);
            showMessage('Ralat: ' + (error.message || error), 'error');
          });
      }

      /**
       * Populate player form with data
       */
      function populatePlayerForm(player) {
        document.getElementById('name').value = player.name || '';
        document.getElementById('age').value = player.age || '';
        document.getElementById('email').value = player.email || '';
        document.getElementById('icNumber').value = player.icNumber || '';
        document.getElementById('parentName').value = player.parentName || '';
        document.getElementById('parentPhone').value = player.parentPhone || '';
        document.getElementById('address').value = player.address || '';
        document.getElementById('school').value = player.school || '';
        document.getElementById('skillLevel').value = player.skillLevel || '';
        document.getElementById('achievement').value = player.achievement || '';
        document.getElementById('parentConsent').value = player.parentConsent || '';

        // Show current image
        if (player.imageUrl) {
          document.getElementById('imagePreviewImg').src = player.imageUrl;
          document.getElementById('imagePreviewImg').style.display = 'block';
          document.getElementById('currentImageInfo').textContent = 'Gambar semasa: ' + (player.imageUrl.substring(0, 50) + '...');
        }

        // Show current IC document
        if (player.icDocumentUrl) {
          var icInfo = document.getElementById('currentICInfo');
          icInfo.innerHTML = '<a href="' + player.icDocumentUrl + '" target="_blank" style="color: #2563eb;">Lihat IC Semasa</a>';
          
          // Show preview if image
          if (player.icDocumentUrl.match(/\.(jpg|jpeg|png|gif)$/i)) {
            var icPreview = document.getElementById('icPreviewContent');
            icPreview.innerHTML = '<img src="' + player.icDocumentUrl + '" alt="IC Preview" style="max-width: 300px; border-radius: 8px; border: 1px solid #d1d5db;" />';
          }
        }

        updateDisplay();
        saveOriginalFormData();
      }

      /**
       * Update avatar and display
       */
      function updateAvatar(player) {
        var avatar = document.getElementById('playerAvatar');
        if (player.imageUrl) {
          avatar.innerHTML = '<img src="' + player.imageUrl + '" alt="' + (player.name || 'Pemain') + '" />';
        } else {
          var initials = (player.name || '')
            .split(' ')
            .filter(function(part) { return part && part.length > 0; })
            .slice(0, 2)
            .map(function(part) { return part.charAt(0).toUpperCase(); })
            .join('');
          avatar.textContent = initials || '?';
        }
      }

      /**
       * Update display name and details
       */
      function updateDisplay() {
        var name = document.getElementById('name').value || '-';
        var school = document.getElementById('school').value || '-';
        var age = document.getElementById('age').value ? document.getElementById('age').value + ' tahun' : '-';
        
        document.getElementById('playerNameDisplay').textContent = name;
        document.getElementById('playerDetailsDisplay').textContent = school + ' • ' + age;
      }

      /**
       * Save original form data
       */
      function saveOriginalFormData() {
        var form = document.getElementById('playerForm');
        var inputs = form.querySelectorAll('input, select, textarea');
        originalFormData = {};
        inputs.forEach(function(input) {
          originalFormData[input.id] = input.value;
        });
      }

      /**
       * Enable edit mode
       */
      function enableEdit() {
        isEditMode = true;
        var inputs = document.getElementById('playerForm').querySelectorAll('input, select, textarea');
        inputs.forEach(function(input) {
          input.disabled = false;
        });
        document.getElementById('editBtn').style.display = 'none';
        document.getElementById('saveBtn').style.display = 'inline-block';
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
      }

      /**
       * Cancel edit
       */
      function cancelEdit() {
        if (isNewPlayer) {
          // For new player, go back to children list
          if (confirm('Batal menambah pemain baru? Perubahan tidak akan disimpan.')) {
            goBack();
          }
          return;
        }
        
        isEditMode = false;
        var inputs = document.getElementById('playerForm').querySelectorAll('input, select, textarea');
        inputs.forEach(function(input) {
          input.disabled = true;
        });
        
        // Restore original values
        Object.keys(originalFormData).forEach(function(key) {
          var input = document.getElementById(key);
          if (input) {
            input.value = originalFormData[key];
          }
        });
        
        document.getElementById('editBtn').style.display = 'inline-block';
        document.getElementById('saveBtn').style.display = 'none';
        document.getElementById('cancelEditBtn').style.display = 'none';
        updateDisplay();
      }

      /**
       * Handle player form submit
       */
      document.getElementById('playerForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!isEditMode) {
          return;
        }

        var formData = {
          name: document.getElementById('name').value.trim(),
          age: document.getElementById('age').value.trim(),
          email: document.getElementById('email').value.trim(),
          icNumber: document.getElementById('icNumber').value.trim(),
          parentName: document.getElementById('parentName').value.trim(),
          parentPhone: document.getElementById('parentPhone').value.trim(),
          address: document.getElementById('address').value.trim(),
          school: document.getElementById('school').value.trim(),
          skillLevel: document.getElementById('skillLevel').value,
          achievement: document.getElementById('achievement').value.trim(),
          parentConsent: document.getElementById('parentConsent').value.trim()
        };

        // Validate required fields
        if (!formData.name || !formData.age || !formData.email || !formData.icNumber || 
            !formData.parentName || !formData.parentPhone || !formData.address || !formData.school || !formData.skillLevel) {
          showMessage('Sila isi semua medan yang wajib.', 'error');
          return;
        }

        var saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Menyimpan...';

        // Show immediate feedback
        showMessage('Sedang menyimpan maklumat...', 'info');

        // Check if new image is selected
        var playerImageFile = document.getElementById('playerImage').files[0];
        var imageUploadPromise = Promise.resolve(null);
        var skipImageUpload = false; // Flag untuk skip upload jika timeout

        if (playerImageFile) {
          // Show message untuk upload image
          showMessage('Sedang upload gambar... Ini mungkin mengambil masa beberapa saat.', 'info');
          // Upload image first
          var reader = new FileReader();
          imageUploadPromise = new Promise(function(resolve, reject) {
            reader.onload = function(e) {
              var base64Data = e.target.result.split(',')[1];
              var fileData = {
                name: playerImageFile.name,
                type: playerImageFile.type,
                data: base64Data
              };

              var playerName = formData.name || 'Player';
              var uploadPromise;
              
              if (typeof google !== 'undefined' && google.script && google.script.run) {
                uploadPromise = new Promise(function(resolve2, reject2) {
                  google.script.run
                    .withSuccessHandler(resolve2)
                    .withFailureHandler(reject2)
                    .uploadPlayerImage(fileData, playerName, currentRowIndex);
                });
              } else if (typeof API !== 'undefined' && API.uploadPlayerImage) {
                uploadPromise = API.uploadPlayerImage(fileData, playerName, currentRowIndex);
              } else {
                reject(new Error('API tidak tersedia'));
                return;
              }

              uploadPromise
                .then(function(result) {
                  var finalResult = result;
                  if (result && result.success !== undefined) {
                    finalResult = result;
                  }
                  if (finalResult.success) {
                    formData.imageUrl = finalResult.fileUrl;
                    resolve(finalResult.fileUrl);
                  } else {
                    reject(new Error(finalResult.message || 'Ralat upload gambar'));
                  }
                })
                .catch(function(error) {
                  // If timeout, resolve dengan null (skip upload)
                  if (skipImageUpload) {
                    resolve(null);
                  } else {
                    reject(error);
                  }
                });
            };
            reader.onerror = function(error) {
              if (skipImageUpload) {
                resolve(null);
              } else {
                reject(error);
              }
            };
            reader.readAsDataURL(playerImageFile);
          }).catch(function(error) {
            // If upload fails or timeout, skip image upload and continue with form save
            if (skipImageUpload) {
              return Promise.resolve(null);
            }
            // Show warning but continue with save
            showMessage('Ralat upload gambar: ' + (error.message || error) + '. Maklumat akan disimpan tanpa gambar baru.', 'error');
            return Promise.resolve(null);
          });
        }

        // Wait for image upload (if any), then update player
        // Set timeout untuk image upload - jika terlalu lama, skip upload image
        var imageUploadTimeout = setTimeout(function() {
          if (playerImageFile) {
            skipImageUpload = true;
            showMessage('Upload gambar mengambil masa terlalu lama. Maklumat akan disimpan tanpa gambar baru.', 'error');
          }
        }, 30000); // 30 seconds timeout untuk image upload

        // Function to save player data (called after image upload or if no image)
        function savePlayerData() {
          var updatePromise;
          
          if (isNewPlayer) {
            // Add new player
            if (typeof google !== 'undefined' && google.script && google.script.run) {
              updatePromise = new Promise(function(resolve, reject) {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .addPlayer(formData);
              });
            } else if (typeof API !== 'undefined' && API.addPlayer) {
              updatePromise = API.addPlayer(formData);
            }
          } else {
            // Update existing player
            if (typeof google !== 'undefined' && google.script && google.script.run) {
              updatePromise = new Promise(function(resolve, reject) {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .updatePlayer(currentRowIndex, formData);
              });
            } else if (typeof API !== 'undefined' && API.updatePlayer) {
              updatePromise = API.updatePlayer(currentRowIndex, formData);
            }
          }

          if (!updatePromise) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Simpan Perubahan';
            showMessage('Error: API tidak tersedia.', 'error');
            return Promise.reject(new Error('API tidak tersedia'));
          }

          return updatePromise;
        }

        // Handle image upload promise
        imageUploadPromise
          .then(function(imageUrl) {
            clearTimeout(imageUploadTimeout);
            if (imageUrl) {
              formData.imageUrl = imageUrl;
              showMessage('Gambar berjaya diupload. Sedang menyimpan maklumat...', 'success');
            }
            // Continue with save
            return savePlayerData();
          })
          .catch(function(uploadError) {
            // If upload fails or timeout, skip image upload and continue with form save
            clearTimeout(imageUploadTimeout);
            if (skipImageUpload || uploadError) {
              showMessage('Upload gambar tidak berjaya. Maklumat akan disimpan tanpa gambar baru.', 'error');
            }
            // Continue with save even if upload failed
            return savePlayerData();
          })
          .then(function(result) {
            // Handle both image upload error and update error
            if (!result || !result.success) {
              throw new Error(result ? result.message : 'Unknown error');
            }
            
            saveBtn.disabled = false;
            saveBtn.textContent = 'Simpan Perubahan';

            var finalResult = result;
            if (result && result.success !== undefined) {
              finalResult = result;
            }

            if (finalResult.success) {
              showMessage('Maklumat pemain berjaya disimpan!', 'success');
              saveOriginalFormData();
              
              // If new player, update rowIndex and reload player data
              if (isNewPlayer && finalResult.rowIndex) {
                currentRowIndex = finalResult.rowIndex;
                isNewPlayer = false;
                // Reload player to get full data
                loadPlayer(currentRowIndex);
              } else {
                // Existing player - disable edit mode
                isEditMode = false;
                var inputs = document.getElementById('playerForm').querySelectorAll('input, select, textarea');
                inputs.forEach(function(input) {
                  input.disabled = true;
                });
                document.getElementById('editBtn').style.display = 'inline-block';
                document.getElementById('saveBtn').style.display = 'none';
                document.getElementById('cancelEditBtn').style.display = 'none';
              }
            } else {
              showMessage(finalResult.message || 'Ralat menyimpan maklumat.', 'error');
            }
          })
          .catch(function(error) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Simpan Perubahan';
            var errorMsg = error.message || error;
            if (typeof error === 'object' && error.success === false) {
              errorMsg = error.message || errorMsg;
            }
            showMessage('Ralat: ' + errorMsg, 'error');
            console.error('Save error:', error);
          });
      });

      /**
       * Preview player image
       */
      document.getElementById('playerImage').addEventListener('change', function(e) {
        var file = e.target.files[0];
        var previewImg = document.getElementById('imagePreviewImg');
        
        if (file) {
          // Check file size (5MB limit)
          if (file.size > 5 * 1024 * 1024) {
            showMessage('Saiz fail terlalu besar. Maksimum 5MB.', 'error');
            e.target.value = '';
            return;
          }
          
          var reader = new FileReader();
          reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewImg.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          previewImg.style.display = 'none';
        }
      });

      /**
       * Upload IC Document
       */
      function uploadICDocument() {
        var icFile = document.getElementById('icDocument').files[0];
        if (!icFile) {
          showMessage('Sila pilih fail IC untuk upload.', 'error');
          return;
        }

        // Check file size (10MB limit)
        if (icFile.size > 10 * 1024 * 1024) {
          showMessage('Saiz fail terlalu besar. Maksimum 10MB.', 'error');
          return;
        }

        var uploadBtn = document.getElementById('uploadICBtn');
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Sedang upload...';

        // Convert file to base64
        var reader = new FileReader();
        reader.onload = function(e) {
          var base64Data = e.target.result.split(',')[1];
          var fileData = {
            name: icFile.name,
            type: icFile.type,
            data: base64Data
          };

          var playerName = document.getElementById('name').value.trim() || 'Player';
          
          // Upload IC document
          var uploadPromise;
          
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            uploadPromise = new Promise(function(resolve, reject) {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .uploadICDocument(fileData, playerName, currentRowIndex);
            });
          } else if (typeof API !== 'undefined' && API.uploadICDocument) {
            uploadPromise = API.uploadICDocument(fileData, playerName, currentRowIndex);
          } else {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload IC';
            showMessage('Error: API tidak tersedia.', 'error');
            return;
          }

          uploadPromise
            .then(function(result) {
              uploadBtn.disabled = false;
              uploadBtn.textContent = 'Upload IC';

              var finalResult = result;
              if (result && result.success !== undefined) {
                finalResult = result;
              }

              if (finalResult.success) {
                showMessage('IC berjaya diupload!', 'success');
                
                // Update player data
                if (currentPlayer) {
                  currentPlayer.icDocumentUrl = finalResult.fileUrl;
                }
                
                // Show preview
                var icInfo = document.getElementById('currentICInfo');
                icInfo.innerHTML = '<a href="' + finalResult.fileUrl + '" target="_blank" style="color: #2563eb;">Lihat IC</a>';
                
                // Show preview if image
                if (icFile.type.startsWith('image/')) {
                  var icPreview = document.getElementById('icPreviewContent');
                  var img = document.createElement('img');
                  img.src = finalResult.fileUrl;
                  img.alt = 'IC Preview';
                  img.style.cssText = 'max-width: 300px; border-radius: 8px; border: 1px solid #d1d5db;';
                  icPreview.innerHTML = '';
                  icPreview.appendChild(img);
                }
                
                document.getElementById('icDocument').value = '';
              } else {
                showMessage(finalResult.message || 'Ralat upload IC', 'error');
              }
            })
            .catch(function(error) {
              uploadBtn.disabled = false;
              uploadBtn.textContent = 'Upload IC';
              showMessage('Ralat: ' + (error.message || error), 'error');
              console.error('Upload IC error:', error);
            });
        };
        reader.readAsDataURL(icFile);
      }

      /**
       * Update player form submit to handle image upload
       * Image will be uploaded when form is submitted if a new image is selected
       */

      /**
       * Update display on input change
       */
      ['name', 'school', 'age'].forEach(function(id) {
        document.getElementById(id).addEventListener('input', updateDisplay);
      });

      /**
       * Show message
       */
      function showMessage(text, type) {
        var container = document.getElementById('messageContainer');
        container.innerHTML = '<div class="message ' + type + '">' + text + '</div>';
        setTimeout(function () {
          container.innerHTML = '';
        }, 5000);
      }

      /**
       * Go back to children list
       */
      function goBack() {
        window.location.href = '/ChildrenList.html';
      }

      // Initialize on page load
      init();
    </script>
  </body>
</html>
